<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8" />
        <link rel="stylesheet" type="text/css" href="css/default.css" />
        <script src="./js/dracula/jquery-1.4.2.min.js"></script>
        <script src="./js/kineticJS/kinetic-v4.0.1.js"></script>
        <script src="./js/dracula/raphael-min.js"></script>
        <script type="text/javascript" src="./js/dracula/dracula_graffle.js"></script>
        <script src="./js/dracula/dracula_graph.js"></script>
        <script src="./js/boardGraph.js"></script>
        <script src="./js/terrain.js"></script>
        <script src="./js/boardSetup.js"></script>
        <script src="./js/imageLoader.js"></script>
        <script src="./js/utils.js"></script>
        <script>
            
            var stage;
            var imageLoader = new Hasl.ImageLoader();
            var selectionLayer = new Kinetic.Layer();
            
            var selectedUnit;
            
            var boardGraph;
            
            function writeMessage(messageLayer, message) {
                var context = messageLayer.getContext();
                messageLayer.clear();
                context.font = "18pt Calibri";
                context.fillStyle = "black";
                context.align = "right";
                context.fillText(message, stage.getWidth()-180, 25);
            }

            
            window.onload = function() {
                stage = new Kinetic.Stage({
                    container: "container",
                    width: 1370,
                    height: 600,
                    draggable: true,
                    dragConstraint: 'horizontal'
                });
                imageLoader.loadImages();
                
                var messageLayer = new Kinetic.Layer();
                var layer = new Kinetic.Layer();

                var terrainDatabases = new Hasl.TerrainDatabases();
                var boardName = 'y';
                var boardY = new Hasl.Board(boardName, 33, 10, terrainDatabases.getDatabase(boardName));
                boardGraph = boardY.getBoardGraph(); //new Hasl.BoardGraph();
                drawBoard(boardGraph, layer, false);
                
                var unitLayer = new Kinetic.Layer();
                drawUnits(unitLayer);
                
                var boardImageLayer = new Kinetic.Layer();
                var sizePair = drawBoardImage(boardImageLayer);
                                
                stage.add(boardImageLayer);
                stage.add(layer);
                stage.add(selectionLayer);
                stage.add(messageLayer);
                
                stage.add(unitLayer);

                stage.setSize(sizePair.first, sizePair.second);
                stage.draw();
            };
            
            // TODO: units should be stored in some sort of database
            //       drawing should be just one aspect
            //       additional data should appear on screen (context sensitive)
            //       concerning movement, los, range, etc...
            //       Obviously a unit object of some sort is necessary!
            function drawUnits(unitLayer) 
            {
                // TODO: associate the unit positions with the BoardGraph
                // TODO: convert unit position on BoardGraph to position on board (screen)
                // we'll want to treat groups of units differently
                addUnit(unitLayer, imageLoader.sources.german_1_e_hs, imageLoader.images.german_1_e_hs, 25, 34);
                addUnit(unitLayer, imageLoader.sources.german_1_e_hs, imageLoader.images.german_1_e_hs, 20, 27);
                addUnit(unitLayer, imageLoader.sources.american_2_e_fs, imageLoader.images.american_2_e_fs, 37.5*2, 60);
            }
            function addUnit(unitLayer, source, image, posX, posY)
            {
                var size = 36;
                var halfSize = size * 0.5;
                var unit = new Kinetic.Image({
                    width: size,
                    height: size,
                    strokeWidth: 4,
                    offset: {x: -halfSize, y: -halfSize},
                    x: posX,
                    y: posY,
                    image: image,
                    stroke: "black",
                    id: source
                });
                // this should only be done for groups...
                unit.on('mousemove', function() {
                    document.body.style.cursor = "pointer";
                    unit.moveToTop(); 
                    
                    unitLayer.draw();
                });
                unit.on('click', function() {
                    if(selectedUnit)
                    {
                        selectedUnit.setStroke('black');
                    }
                    var unitUnSelected = (selectedUnit == unit);
                    if(unitUnSelected)
                    {
                        $('#selectedUnit').attr('src', '');
                        selectedUnit = undefined;
                        return;
                    }
                    selectedUnit = unit;
                    selectedUnit.setStroke('red');
                    unitLayer.draw();
                    
                    $('#selectedUnit').attr('src', unit.getId())
                });
            unit.on('mouseout', function(){
                document.body.style.cursor = "default"; 
            });
            unitLayer.add(unit);
        }
        function drawBoardImage(boardImageLayer)
        {
            var board_y = new Kinetic.Image({
                image: imageLoader.images.board_y,
                stroke: 'white',
                strokeWidth: 6,
                listening: false
            });
            var sizePair = new Utils.Pair(board_y.getWidth(), board_y.getHeight());
            boardImageLayer.add(board_y);
            return sizePair;
        }
        </script>
    </head>
    <body>
        <div id="container"></div>
        <div id="info">
            <img id="selectedUnit" src=""/>
            <p id="terrainInfo"></p>
        </div>
    </body>
</html>