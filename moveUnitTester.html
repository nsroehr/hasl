<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8" />
        <link rel="stylesheet" type="text/css" href="css/default.css" />
        <script src="./js/dracula/jquery-1.4.2.min.js"></script>
        <script src="./js/kineticJS/kinetic-v4.0.1.js"></script>
        <script src="./js/dracula/raphael-min.js"></script>
        <script type="text/javascript" src="./js/dracula/dracula_graffle.js"></script>
        <script src="./js/dracula/dracula_graph.js"></script>
        <!-- 
            TODO: remove me please! 
            <script src="./js/boardGraph.js"></script>
        -->
        <script src="./js/scenarios.js"></script>
        <script src="./js/terrains.js"></script>
        <script src="./js/terrain.js"></script>
        
        <script src="./js/boardSetup.js"></script>
        <script src="./js/imageLoader.js"></script>
        <script src="./js/utils.js"></script>
        <script>
            
            var stage;
            
            var selectionLayer = new Kinetic.Layer();
            
            var selectedUnit;
            
            var boardGraph;
            
            function writeMessage(messageLayer, message) {
                var context = messageLayer.getContext();
                messageLayer.clear();
                context.font = "18pt Calibri";
                context.fillStyle = "black";
                context.align = "right";
                context.fillText(message, stage.getWidth()-180, 25);
            }

            
            window.onload = function() {
//                // desired super high-level API
//                var scenario = Hasl.Scenario(Hasl.Scenarios.Veirville); // we only have one for now
//             
//                var game = Hasl.Game(scenario);
//                // need some way to deal with 'players'...
//                // scenario declares which player goes first
//                game.start();
//            }
//
//            
//
//            Hasl.Game = function(scenario)
//            {
//                var that = {};
//                var renderer = Hasl.Renderer();
//                
//              
//            };
                stage = new Kinetic.Stage({
                    container: "container",
                    width: 1370,
                    height: 600,
                    draggable: true,
                    dragConstraint: 'horizontal'
                });
                var imageLoader = Hasl.ImageLoader(Hasl.ImageSourceDatabase);
                
                var messageLayer = new Kinetic.Layer();
                var layer = new Kinetic.Layer();

                var scenario = Hasl.Scenarios.Vierville;
                console.log(scenario);
                var board = Hasl.Board(scenario.board.type, scenario.board.configuration);
                var boardGraph = board.getBoardGraph(); //new Hasl.BoardGraph();
                drawBoard(boardGraph, layer, false);
                
                var unitLayer = new Kinetic.Layer();
                drawUnits(unitLayer, imageLoader);
                
                var boardImageLayer = new Kinetic.Layer();
                var sizePair = drawBoardImage(boardImageLayer, imageLoader.getImage(imageLoader.getDatabase().board_y));
                                
                stage.add(boardImageLayer);
                stage.add(layer);
                stage.add(selectionLayer);
                stage.add(messageLayer);
                
                stage.add(unitLayer);

                stage.setSize(sizePair.first, sizePair.second);
                stage.draw();
            };
            
            // TODO: units should be stored in some sort of database
            //       drawing should be just one aspect
            //       additional data should appear on screen (context sensitive)
            //       concerning movement, los, range, etc...
            //       Obviously a unit object of some sort is necessary!
            function drawUnits(unitLayer, imageLoader) 
            {
                // TODO: associate the unit positions with the BoardGraph
                // TODO: convert unit position on BoardGraph to position on board (screen)
                // we'll want to treat groups of units differently
                addUnit(unitLayer, imageLoader.getImage(imageLoader.getDatabase().german_1_e_hs), 25, 34);
                addUnit(unitLayer, imageLoader.getImage(imageLoader.getDatabase().german_1_e_hs), 20, 27);
                addUnit(unitLayer, imageLoader.getImage(imageLoader.getDatabase().american_2_e_fs), 37.5*2, 60);
            }
            function addUnit(unitLayer, imageFromLoader, posX, posY)
            {
                var size = 36;
                var halfSize = size * 0.5;
                var unit = new Kinetic.Image({
                    width: size,
                    height: size,
//                    strokeWidth: 4,
                    offset: {x: -halfSize, y: -halfSize},
                    x: posX,
                    y: posY,
                    image: imageFromLoader,
//                    stroke: "black",
                    id: imageFromLoader.src
                });
                // this should only be done for groups...
                unit.on('mousemove', function() {
                    document.body.style.cursor = "pointer";
                    unit.moveToTop(); 
                    
                    unitLayer.draw();
                });
                unit.on('click', function() {
                    if(selectedUnit)
                    {
                        selectedUnit.setStroke('transparent');
                    }
                    var unitUnSelected = (selectedUnit == unit);
                    if(unitUnSelected)
                    {
                        $('#selectedUnit').attr('src', '');
                        selectedUnit = undefined;
                        return;
                    }
                    selectedUnit = unit;
                    selectedUnit.setStroke('red');
                    unitLayer.draw();
                    
                    $('#selectedUnit').attr('src', unit.getId())
                });
            unit.on('mouseout', function(){
                document.body.style.cursor = "default"; 
            });
            unitLayer.add(unit);
        }
        function drawBoardImage(boardImageLayer, boardImage)
        {
            var board_y = new Kinetic.Image({
                image: boardImage,
                stroke: 'white',
                strokeWidth: 6,
                listening: false
            });
            var sizePair = new Utils.Pair(board_y.getWidth(), board_y.getHeight());
            boardImageLayer.add(board_y);
            return sizePair;
        }
        </script>
    </head>
    <body>
        <div id="container"></div>
        <div id="info">
            <img id="selectedUnit" src=""/>
            <p id="terrainInfo"></p>
        </div>
    </body>
</html>